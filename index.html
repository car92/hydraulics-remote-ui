<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hydraulics Remote</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background-color: #111;
    color: #fff;
    text-align: center;
    margin: 0;
  }
  h1 { margin-top: 1rem; font-size: 1.4rem; }
  button {
    background: #222;
    color: #fff;
    border: 1px solid #333;
    border-radius: 0.4rem;
    margin: 0.3rem;
    padding: 0.7rem 1rem;
    font-size: 1rem;
  }
  button:active, button.active { background: #007aff; }
  #log {
    background: #000;
    color: #0f0;
    font-family: monospace;
    padding: 0.5rem;
    height: 240px;
    overflow-y: auto;
    text-align: left;
    border-top: 1px solid #333;
  }
</style>
</head>
<body>

<h1>Hydraulics Remote</h1>
<button id="connectBtn">Connect (Bluetooth)</button>
<div id="status">Disconnected</div>

<div style="margin-top:1rem;">
  <button id="testLight">Test Light</button>
  <button id="testMedium">Test Medium</button>
</div>

<div style="margin-top:1rem;">
  <button class="func" data-id="0">Mainsheet</button>
  <button class="func" data-id="1">Outhaul</button>
  <button class="func" data-id="2">Backstay</button>
  <button class="func" data-id="3">Vang</button>
  <button class="func" data-id="4">Cunningham</button>
  <button class="func" data-id="5">Furler</button>
  <button class="func" data-id="6">Jib Halyard</button>
  <button class="func" data-id="7">Jib Car</button>
  <button class="func" data-id="8">Inner Forestay</button>
</div>

<div id="log"></div>

<script>
const UUID_SVC  = "0000f00d-0000-1000-8000-00805f9b34fb";
const UUID_CMD  = "0000f0c1-0000-1000-8000-00805f9b34fb";
const UUID_EVT  = "0000f0e2-0000-1000-8000-00805f9b34fb";
const enc = new TextEncoder();
const dec = new TextDecoder();
let BLE = { device:null, server:null, svc:null, cmd:null, evt:null, connected:false };

function log(msg){
  const el = document.getElementById("log");
  el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
}

async function connectBLE(){
  try {
    log("Requesting BLE device...");
    BLE.device = await navigator.bluetooth.requestDevice({
      filters:[{ namePrefix:"HydraulicsRX" }],
      optionalServices:[UUID_SVC]
    });
    BLE.device.addEventListener('gattserverdisconnected', onDisconnect);
    BLE.server = await BLE.device.gatt.connect();
    BLE.svc = await BLE.server.getPrimaryService(UUID_SVC);
    BLE.cmd = await BLE.svc.getCharacteristic(UUID_CMD);
    BLE.evt = await BLE.svc.getCharacteristic(UUID_EVT);

    await BLE.evt.startNotifications();
    BLE.evt.addEventListener('characteristicvaluechanged', evt=>{
      const val = dec.decode(evt.target.value);
      log("RX: " + val.trim());
    });

    BLE.connected = true;
    document.getElementById("status").innerText = "Connected ✅";
    log("BLE connected to HydraulicsRX");
  } catch(err){
    log("Connect failed: " + err);
  }
}

function onDisconnect(){
  BLE.connected = false;
  document.getElementById("status").innerText = "Disconnected ❌";
  log("BLE disconnected");
}

async function bleSend(line){
  if(!BLE.connected || !BLE.cmd) return;
  const data = enc.encode(line + "\n");
  try{
    // Always write with response (reliable across Android/iOS)
    await BLE.cmd.writeValueWithResponse(data);
    log("TX: " + line);
  }catch(e){
    log("Write failed: " + e);
  }
}

document.getElementById("connectBtn").onclick = connectBLE;

// Test buttons
document.getElementById("testLight").onclick = ()=>bleSend("S:11,F:1");
document.getElementById("testMedium").onclick = ()=>bleSend("S:12,F:2");

// Function buttons
for(const b of document.querySelectorAll(".func")){
  b.onclick = ()=>{
    const id = b.dataset.id;
    bleSend("S:" + id);
  };
}
</script>

</body>
</html>